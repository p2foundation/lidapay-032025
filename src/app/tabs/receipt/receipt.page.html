<ion-header [translucent]="true" class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <ion-title>{{'Receipt' | translate}}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="downloadOrShareReceipt('share')" [disabled]="isGeneratingPdf" fill="clear">
        <ion-icon name="share-social-outline" slot="icon-only"></ion-icon>
      </ion-button>
      <ion-button (click)="downloadOrShareReceipt('download')" [disabled]="isGeneratingPdf" fill="clear">
        <ion-icon name="download-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <div *ngIf="isGeneratingPdf" class="ion-text-center ion-padding">
    <ion-spinner></ion-spinner>
    <p>Generating receipt...</p>
  </div>

  <div id="receipt-card" class="receipt-container" #receiptContent>
    <div class="receipt-header">
      <ion-icon 
        [name]="isTransactionSuccessful() ? 'checkmark-circle-outline' : 'close-circle-outline'" 
        [color]="getStatusColor()" 
        class="status-icon">
      </ion-icon>
      <h2>{{ getHeaderText() | translate }}</h2>
      <p class="transaction-amount">
        {{data.currency || 'GHS'}} {{data.amount || data.requestedAmount | number:'1.2-2'}}
      </p>
      <div class="transaction-id-header">
        <span class="transaction-id-label">{{ 'Transaction ID' | translate }}</span>
        <div class="transaction-id-container" 
             (click)="showFullTransactionId()" 
             (touchstart)="onTransactionIdTouchStart($event)"
             (touchend)="onTransactionIdTouchEnd($event)"
             (touchcancel)="onTransactionIdTouchCancel($event)">
          <span class="transaction-id-display">{{getTruncatedTransactionId()}}</span>
          <ion-icon name="eye-outline" class="view-icon" *ngIf="isTransactionIdLong()"></ion-icon>
        </div>
      </div>
      <p class="receipt-date">{{currentDate}}</p>
    </div>

    <ion-list lines="full" class="receipt-body">
      <ion-item>
        <ion-label>{{ 'Status' | translate }}</ion-label>
        <ion-note slot="end">
          <ion-text [color]="getStatusColor()">
            {{ getStatusText() | translate }}
          </ion-text>
        </ion-note>
      </ion-item>

      <ion-item class="transaction-id-item" 
                (click)="showFullTransactionId()"
                (touchstart)="onTransactionIdTouchStart($event)"
                (touchend)="onTransactionIdTouchEnd($event)"
                (touchcancel)="onTransactionIdTouchCancel($event)">
        <ion-label>{{ 'Transaction ID' | translate }}</ion-label>
        <ion-note slot="end" class="transaction-id-value">
          <div class="transaction-id-note-container">
            <span>{{getTruncatedTransactionId()}}</span>
            <ion-icon name="eye-outline" class="view-icon-small" *ngIf="isTransactionIdLong()"></ion-icon>
          </div>
        </ion-note>
      </ion-item>

      <ion-item *ngIf="data.orderId">
        <ion-label>{{ 'Order ID' | translate }}</ion-label>
        <ion-note slot="end">{{data.orderId}}</ion-note>
      </ion-item>

      <ion-item *ngIf="data.network || data.operatorName">
        <ion-label>{{ 'Network' | translate }}</ion-label>
        <ion-note slot="end">{{data.network || data.operatorName}}</ion-note>
      </ion-item>

      <ion-item *ngIf="data.recipientPhone || data.recipientNumber" (click)="showFullRecipientNumber()" class="recipient-item">
        <ion-label>{{ 'Recipient' | translate }}</ion-label>
        <ion-note slot="end" class="recipient-number-value">
          <div class="recipient-number-container">
            <span>{{getFullRecipientNumber()}}</span>
            <ion-icon name="eye-outline" class="view-icon-small"></ion-icon>
          </div>
        </ion-note>
      </ion-item>

      <ion-item *ngIf="data.recipientEmail">
        <ion-label>{{ 'Email' | translate }}</ion-label>
        <ion-note slot="end">{{data.recipientEmail}}</ion-note>
      </ion-item>

      <ion-item *ngIf="data.message || data.customIdentifier">
        <ion-label>{{ 'Message' | translate }}</ion-label>
        <ion-note slot="end" class="ion-text-wrap">{{data.message || data.customIdentifier}}</ion-note>
      </ion-item>

      <ion-item *ngIf="data.timestamp">
        <ion-label>{{ 'Date & Time' | translate }}</ion-label>
        <ion-note slot="end">{{formatDate(data.timestamp)}}</ion-note>
      </ion-item>

      <!-- Show error message if transaction failed -->
      <ion-item *ngIf="!isTransactionSuccessful() && data.message" class="error-message">
        <ion-label>{{ 'Error Details' | translate }}</ion-label>
        <ion-note slot="end" class="ion-text-wrap" color="danger">{{data.message}}</ion-note>
      </ion-item>

      <!-- Show crediting failure details if payment succeeded but crediting failed -->
      <ion-item *ngIf="data.status === 'PAYMENT_SUCCESS_CREDITING_FAILED' && data.errorDetails" class="crediting-failure-message">
        <ion-label>{{ 'Crediting Error' | translate }}</ion-label>
        <ion-note slot="end" class="ion-text-wrap" color="warning">{{data.errorDetails}}</ion-note>
      </ion-item>
    </ion-list>

    <div class="receipt-footer">
      <p *ngIf="isTransactionSuccessful() && !hasAirtimeCreditingFailed()">{{ 'Thank you for your transaction!' | translate }}</p>
      <p *ngIf="isTransactionSuccessful() && hasAirtimeCreditingFailed()" class="warning-message">
        <ion-icon name="warning-outline" color="warning"></ion-icon>
        Payment successful, but airtime crediting is pending. Please check status.
      </p>
      <p *ngIf="!isTransactionSuccessful()">{{ 'Transaction could not be completed.' | translate }}</p>
      <small>{{ 'This is a computer generated receipt' | translate }}</small>
    </div>
  </div>

  <!-- Smart Action Buttons for Failed Airtime Crediting -->
  <div *ngIf="isTransactionSuccessful() && hasAirtimeCreditingFailed()" class="smart-actions ion-margin-bottom">
    <ion-card class="warning-card">
      <ion-card-content>
        <div class="warning-header">
          <ion-icon name="alert-circle-outline" color="warning" size="large"></ion-icon>
          <h3>Airtime Crediting Pending</h3>
          <p>Your payment was successful, but airtime crediting is still processing. We'll automatically check the status for you.</p>
        </div>
        
        <div class="status-check-section">
          <ion-button expand="block" (click)="checkAirtimeStatus()" color="warning" class="ion-margin-bottom">
            <ion-icon name="refresh-outline" slot="start"></ion-icon>
            Check Airtime Status Now
          </ion-button>
          
          <ion-button expand="block" (click)="goToPendingTransactions()" fill="outline" color="warning">
            <ion-icon name="time-outline" slot="start"></ion-icon>
            View Pending Transactions
          </ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </div>

  <div class="action-buttons">
    <ion-button expand="block" (click)="downloadOrShareReceipt('download')" [disabled]="isGeneratingPdf" class="ion-margin-bottom" color="primary">
      <ion-icon name="download-outline" slot="start"></ion-icon>
      {{ isGeneratingPdf ? ('Generating...' | translate) : ('Download Receipt' | translate) }}
    </ion-button>

    <ion-button expand="block" (click)="downloadOrShareReceipt('share')" [disabled]="isGeneratingPdf" class="ion-margin-bottom" color="secondary">
      <ion-icon name="share-social-outline" slot="start"></ion-icon>
      {{ isGeneratingPdf ? ('Preparing...' | translate) : ('Share Receipt' | translate) }}
    </ion-button>

    <ion-button expand="block" (click)="goToTransaction()" fill="outline" class="ion-margin-bottom">
      <ion-icon name="document-text-outline" slot="start"></ion-icon>
      {{ 'View Transaction' | translate }}
    </ion-button>

    <ion-button expand="block" (click)="tabs()" fill="clear">
      <ion-icon name="home-outline" slot="start"></ion-icon>
      {{ 'Back to Home' | translate }}
    </ion-button>
  </div>
</ion-content>
