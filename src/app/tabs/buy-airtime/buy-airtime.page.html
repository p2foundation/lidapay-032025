<ion-header class="header_bg bg-transparent">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <ion-title>
      <div class="d-flex">
        <span class="page_title animate__animated animate__fadeIn">
          {{'Airtime Topup' | translate}}
        </span>
      </div>
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-header collapse="condense">
    <ion-toolbar>
      <ion-title size="large">{{ 'Airtime Topup' | translate}}</ion-title>
    </ion-toolbar>
  </ion-header>
    <!-- Skeleton Loading -->
    <div class="skeleton-wrapper" *ngIf="isLoading">
      <ion-list lines="none">
        <!-- Info Card Skeleton -->
        <ion-card>
          <ion-card-content>
            <div class="skeleton-header">
              <ion-skeleton-text [animated]="true" style="width: 48px; height: 48px; border-radius: 50%;"></ion-skeleton-text>
              <div class="skeleton-text-group">
                <ion-skeleton-text [animated]="true" style="width: 60%; height: 20px;"></ion-skeleton-text>
                <ion-skeleton-text [animated]="true" style="width: 80%; height: 16px; margin-top: 8px;"></ion-skeleton-text>
              </div>
            </div>
          </ion-card-content>
        </ion-card>
  
        <!-- Form Fields Skeleton -->
        <div class="form-skeleton ion-padding">
          <div class="skeleton-input-container">
            <ion-skeleton-text [animated]="true" style="width: 30%; height: 16px; margin-bottom: 8px;"></ion-skeleton-text>
            <ion-skeleton-text [animated]="true" style="width: 100%; height: 48px; border-radius: 8px;"></ion-skeleton-text>
          </div>
  
          <div class="skeleton-input-container" style="margin-top: 24px;">
            <ion-skeleton-text [animated]="true" style="width: 25%; height: 16px; margin-bottom: 8px;"></ion-skeleton-text>
            <ion-skeleton-text [animated]="true" style="width: 100%; height: 48px; border-radius: 8px;"></ion-skeleton-text>
          </div>
  
          <div class="skeleton-input-container" style="margin-top: 24px;">
            <ion-skeleton-text [animated]="true" style="width: 20%; height: 16px; margin-bottom: 8px;"></ion-skeleton-text>
            <ion-skeleton-text [animated]="true" style="width: 100%; height: 48px; border-radius: 8px;"></ion-skeleton-text>
          </div>
  
          <!-- Submit Button Skeleton -->
          <ion-skeleton-text [animated]="true" style="width: 100%; height: 48px; border-radius: 24px; margin-top: 32px;"></ion-skeleton-text>
        </div>
  
        <!-- Quick Amounts Skeleton -->
        <div class="quick-amounts-skeleton ion-padding">
          <ion-skeleton-text [animated]="true" style="width: 30%; height: 20px; margin-bottom: 16px;"></ion-skeleton-text>
          <ion-grid>
            <ion-row>
              <ion-col size="4" *ngFor="let i of [1,2,3,4,5,6]">
                <ion-skeleton-text [animated]="true" style="width: 100%; height: 40px; border-radius: 8px;"></ion-skeleton-text>
              </ion-col>
            </ion-row>
          </ion-grid>
        </div>
  
        <!-- Features Skeleton -->
        <div class="features-skeleton ion-padding">
          <ion-grid>
            <ion-row>
              <ion-col size="6" *ngFor="let i of [1,2]">
                <div class="feature-skeleton-card">
                  <ion-skeleton-text [animated]="true" style="width: 40px; height: 40px; border-radius: 50%; margin: 0 auto;"></ion-skeleton-text>
                  <ion-skeleton-text [animated]="true" style="width: 50%; height: 16px; margin: 12px auto 4px;"></ion-skeleton-text>
                  <ion-skeleton-text [animated]="true" style="width: 70%; height: 12px; margin: 4px auto;"></ion-skeleton-text>
                </div>
              </ion-col>
            </ion-row>
          </ion-grid>
        </div>
      </ion-list>
    </div>
  
    <!-- Actual Content -->
    <div class="content-wrapper" [class.animate-in]="!isLoading">
      <!-- Info Card -->
      <ion-card class="info-card animate__animated animate__fadeInDown animate__delay-1s">
        <ion-card-content>
          <div class="card-header">
            <ion-icon name="phone-portrait-outline" class="header-icon"></ion-icon>
            <h2>Mobile Airtime</h2>
          </div>
          <p>Top up any mobile number in Ghana instantly.</p>
        </ion-card-content>
      </ion-card>
  
      <!-- Form Section -->
      <form [formGroup]="airtimeForm" (ngSubmit)="topupFormSubmit(airtimeForm.value)" class="form-container">
        <!-- Country Selection -->
        <ion-item class="animate__animated animate__fadeInUp animate__delay-1s">
          <ion-label position="stacked">Country</ion-label>
          <ion-select
            formControlName="countryIso"
            interface="action-sheet"
            [interfaceOptions]="{ header: 'Select Country' }"
            placeholder="Choose country"
            class="country-select">
            <ion-select-option *ngFor="let country of countries" [value]="country.isoName">
              {{ country.flag }} {{ country.name }}
            </ion-select-option>
          </ion-select>
          <ion-note slot="error" *ngIf="airtimeForm.get('countryIso')?.touched && airtimeForm.get('countryIso')?.invalid">
            Please select a country
          </ion-note>
        </ion-item>

        <!-- Network Selection -->
        <ion-item class="animate__animated animate__fadeInUp animate__delay-2s">
          <ion-label position="stacked">Network Provider</ion-label>
          <ion-select
            formControlName="network"
            interface="action-sheet"
            [interfaceOptions]="{ header: 'Select Network' }"
            placeholder="Choose network"
            class="network-select">
            <ion-select-option value="0">Auto Detect Network</ion-select-option>
            <ion-select-option *ngFor="let operator of operators" [value]="operator.id">
              {{ operator.name }}
            </ion-select-option>
          </ion-select>
          <ion-note slot="error" *ngIf="airtimeForm.get('network')?.touched && airtimeForm.get('network')?.invalid">
            Please select a network
          </ion-note>
        </ion-item>
  
        <!-- Phone Number -->
        <ion-item class="animate__animated animate__fadeInUp animate__delay-3s">
          <ion-label position="stacked">Phone Number</ion-label>
          <ion-input
            formControlName="recipientNumber"
            type="tel"
            placeholder="Enter phone number"
            class="custom-input"
            inputmode="tel"
            enterkeyhint="next"
            autocomplete="tel"
            autocorrect="off"
            autocapitalize="off"
            clearInput="true"
            maxlength="15"
            (ionInput)="onPhoneNumberInput($event)"
            (ionFocus)="onInputFocus($event, 'recipientNumber')"
            (ionBlur)="onInputBlur()">
          </ion-input>
          
          <!-- Auto-detection indicator -->
          <div class="auto-detect-info" *ngIf="isDetectingOperator">
            <ion-spinner name="dots" size="small"></ion-spinner>
            <span class="text-body-small text-gray-600">Detecting network...</span>
          </div>
          
          <!-- Detected operator display -->
          <div class="detected-operator" *ngIf="detectedOperator && !isDetectingOperator">
            <ion-chip color="primary" outline>
              <ion-icon name="checkmark-circle"></ion-icon>
              <ion-label>{{ detectedOperator.name }} detected</ion-label>
            </ion-chip>
          </div>
          
          <ion-note slot="error" *ngIf="airtimeForm.get('recipientNumber')?.touched && airtimeForm.get('recipientNumber')?.invalid">
            Please enter a valid phone number
          </ion-note>
        </ion-item>
  
        <!-- Amount -->
        <ion-item class="animate__animated animate__fadeInUp animate__delay-4s">
          <ion-label position="stacked">Amount (GHS)</ion-label>
          <ion-input
            formControlName="amount"
            type="number"
            placeholder="Enter amount"
            class="custom-input"
            inputmode="decimal"
            enterkeyhint="done"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            clearInput="true"
            (ionFocus)="onInputFocus($event, 'amount')"
            (ionBlur)="onInputBlur()">
          </ion-input>
          <ion-note slot="error" *ngIf="airtimeForm.get('amount')?.touched && airtimeForm.get('amount')?.invalid">
            Please enter a valid amount
          </ion-note>
        </ion-item>
  
        <!-- Submit Button -->
        <div class="submit-button-container animate__animated animate__fadeInUp animate__delay-5s">
          <ion-button 
            expand="block" 
            type="submit"
            [disabled]="!airtimeForm.valid"
            class="submit-button">
            <ion-icon name="send-outline" slot="start"></ion-icon>
            {{'Submit Payment' | translate}}
          </ion-button>
        </div>
      </form>
  
      <!-- Enhanced Operator Selection -->
      <div class="operators-section animate__animated animate__fadeInUp animate__delay-6s" *ngIf="enhancedOperators.length > 0">
        <h3>Available Networks</h3>
        <p class="section-subtitle">Select your preferred network provider</p>
        
        <div class="operators-grid">
          <div 
            class="operator-card" 
            *ngFor="let operator of enhancedOperators; let i = index"
            [class.selected]="selectedOperator?.name === operator.name"
            (click)="selectOperator(operator)"
            [style.animation-delay]="(i * 0.1) + 's'">
            
            <div class="operator-logo">
              <img [src]="operator.logo" [alt]="operator.displayName + ' logo'" 
                   [title]="operator.displayName + ' logo'"
                   [style.background-color]="operator.primaryColor"
                   class="logo-image">
            </div>
            
            <div class="operator-info">
              <h4 class="operator-name">{{ operator.displayName }}</h4>
              <p class="operator-services">
                <ion-chip size="small" color="success" *ngIf="operatorSupportsService(operator, 'airtime')">
                  <ion-icon name="call-outline"></ion-icon>
                  <ion-label>Airtime</ion-label>
                </ion-chip>
                <ion-chip size="small" color="primary" *ngIf="operatorSupportsService(operator, 'data')">
                  <ion-icon name="wifi-outline"></ion-icon>
                  <ion-label>Data</ion-label>
                </ion-chip>
                <ion-chip size="small" color="warning" *ngIf="operatorSupportsService(operator, 'sms')">
                  <ion-icon name="chatbubble-outline"></ion-icon>
                  <ion-label>SMS</ion-label>
                </ion-chip>
              </p>
              
              <div class="operator-features" *ngIf="getOperatorFeatures(operator).length > 0">
                <ion-chip size="small" color="medium" *ngFor="let feature of getOperatorFeatures(operator)">
                  <ion-label>{{ feature }}</ion-label>
                </ion-chip>
              </div>
            </div>
            
            <div class="operator-popularity" *ngIf="operator.popularity >= 8">
              <ion-icon name="star" color="warning"></ion-icon>
              <span>Popular</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Amount Selection -->
      <div class="quick-amounts animate__animated animate__fadeInUp animate__delay-7s">
        <h3>Quick Amounts</h3>
        <ion-grid>
          <ion-row>
            <ion-col size="4" *ngFor="let amount of getQuickAmountsForOperator()">
              <div class="amount-chip" (click)="selectAmount(amount)">
                <span>{{ selectedCountry?.currencyCode || 'GHS' }} {{amount}}</span>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>
      </div>
  
      <!-- Features Section -->
      <div class="features-section">
        <ion-grid>
          <ion-row>
            <ion-col size="6" class="animate__animated animate__fadeInUp animate__delay-7s">
              <div class="feature-card">
                <ion-icon name="flash-outline"></ion-icon>
                <h4>Instant</h4>
                <p>Quick delivery</p>
              </div>
            </ion-col>
            <ion-col size="6" class="animate__animated animate__fadeInUp animate__delay-7s">
              <div class="feature-card">
                <ion-icon name="shield-checkmark-outline"></ion-icon>
                <h4>Secure</h4>
                <p>Safe transactions</p>
              </div>
            </ion-col>
          </ion-row>
        </ion-grid>
      </div>
    </div>
</ion-content>
