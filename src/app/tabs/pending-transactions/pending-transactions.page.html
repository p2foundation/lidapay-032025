<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <ion-title>Pending Transactions</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="refreshTransactions()" [disabled]="isLoading">
        <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Loading pending transactions...</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && filteredTransactions.length === 0" class="empty-state">
    <ion-icon name="checkmark-circle-outline" color="success" size="large"></ion-icon>
    <h2>No Pending Transactions</h2>
    <p>All your transactions have been processed successfully!</p>
  </div>

  <!-- Content -->
  <div *ngIf="!isLoading && filteredTransactions.length > 0">
    <!-- Search and Filter Section -->
    <ion-card class="filter-card">
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="12" size-md="8">
              <ion-item>
                <ion-label position="stacked">Search Transactions</ion-label>
                <ion-input 
                  [(ngModel)]="searchTerm" 
                  placeholder="Search by phone number, transaction type, or ID"
                  clearInput="true">
                </ion-input>
              </ion-item>
            </ion-col>
            <ion-col size="12" size-md="4">
              <ion-item>
                <ion-label position="stacked">Status Filter</ion-label>
                <ion-select [(ngModel)]="filterStatus">
                  <ion-select-option value="ALL">All Status</ion-select-option>
                  <ion-select-option value="PENDING">Pending</ion-select-option>
                  <ion-select-option value="COMPLETED">Completed</ion-select-option>
                  <ion-select-option value="FAILED">Failed</ion-select-option>
                </ion-select>
              </ion-item>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- Results Summary -->
    <div class="results-summary">
      <p>Showing {{ filteredTransactions.length }} of {{ pendingTransactions.length }} pending transactions</p>
    </div>

    <!-- Transactions List -->
    <ion-list>
      <ion-card *ngFor="let transaction of filteredTransactions" class="transaction-card">
        <ion-card-content>
          <!-- Transaction Header -->
          <div class="transaction-header">
            <div class="transaction-type">
              <ion-chip [color]="getStatusColor(transaction.status?.transaction || 'unknown')" outline>
                <ion-label>{{ getTransactionTypeLabel(transaction.transType) }}</ion-label>
              </ion-chip>
            </div>
            <div class="transaction-status">
              <ion-badge [color]="getStatusColor(transaction.status?.transaction || 'unknown')">
                {{ transaction.status?.transaction?.toUpperCase() || 'UNKNOWN' }}
              </ion-badge>
            </div>
          </div>

          <!-- Transaction Details -->
          <div class="transaction-details">
            <div class="detail-row">
              <span class="label">Amount:</span>
              <span class="value amount">{{ transaction.monetary.currency }} {{ formatAmount(transaction.monetary.amount) }}</span>
            </div>
            
            <div class="detail-row">
              <span class="label">Recipient:</span>
              <span class="value phone">{{ formatPhoneNumber(transaction.recipientNumber) }}</span>
            </div>
            
            <div class="detail-row">
              <span class="label">Transaction ID:</span>
              <span class="value transaction-id">{{ transaction.transId }}</span>
            </div>
            
            <div class="detail-row">
              <span class="label">Retailer:</span>
              <span class="value">{{ transaction.retailer }}</span>
            </div>
            
            <div class="detail-row">
              <span class="label">Customer:</span>
              <span class="value">{{ transaction.firstName }} {{ transaction.lastName }}</span>
            </div>
            
            <div class="detail-row">
              <span class="label">Created:</span>
              <span class="value">{{ formatDate(transaction.createdAt) }}</span>
            </div>
            
            <div class="detail-row">
              <span class="label">Updated:</span>
              <span class="value">{{ formatDate(transaction.updatedAt) }}</span>
            </div>
          </div>

          <!-- Status Details -->
          <div class="status-details">
            <h4>Status Breakdown:</h4>
            <div class="status-grid">
                          <div class="status-item">
              <ion-icon [name]="getStatusIcon(transaction.status?.transaction || 'unknown')" 
                       [color]="getStatusColor(transaction.status?.transaction || 'unknown')"></ion-icon>
              <span>Transaction: {{ transaction.status?.transaction || 'N/A' }}</span>
            </div>
            <div class="status-item">
              <ion-icon [name]="getStatusIcon(transaction.status?.service || 'unknown')" 
                       [color]="getStatusColor(transaction.status?.service || 'unknown')"></ion-icon>
              <span>Service: {{ transaction.status?.service || 'N/A' }}</span>
            </div>
            <div class="status-item">
              <ion-icon [name]="getStatusIcon(transaction.status?.payment || 'unknown')" 
                       [color]="getStatusColor(transaction.status?.payment || 'unknown')"></ion-icon>
              <span>Payment: {{ transaction.status?.payment || 'N/A' }}</span>
            </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="transaction-actions">
            <ion-button 
              expand="block" 
              color="primary" 
              (click)="checkTransactionStatus(transaction)"
              [disabled]="isCheckingStatus && checkingTransactionId === transaction._id">
              <ion-icon name="refresh-outline" slot="start" *ngIf="isCheckingStatus && checkingTransactionId === transaction._id"></ion-icon>
              <ion-spinner name="dots" slot="start" *ngIf="isCheckingStatus && checkingTransactionId === transaction._id"></ion-spinner>
              <ion-icon name="time-outline" slot="start" *ngIf="!(isCheckingStatus && checkingTransactionId === transaction._id)"></ion-icon>
              {{ (isCheckingStatus && checkingTransactionId === transaction._id) ? 'Checking...' : 'Check Status' }}
            </ion-button>
            
            <ion-button 
              expand="block" 
              fill="outline" 
              color="secondary" 
              (click)="viewTransactionDetails(transaction)"
              [disabled]="isCheckingStatus">
              <ion-icon name="eye-outline" slot="start"></ion-icon>
              View Details
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
    </ion-list>

    <!-- Load More Button -->
    <div *ngIf="hasMoreData && !isLoading" class="load-more-container">
      <ion-button 
        expand="block" 
        fill="outline" 
        color="medium"
        (click)="loadMoreTransactions()">
        <ion-icon name="arrow-down-outline" slot="start"></ion-icon>
        Load More Transactions
      </ion-button>
    </div>
  </div>

  <!-- Floating Action Button for Refresh -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="!isLoading">
    <ion-fab-button (click)="refreshTransactions()" [disabled]="isLoading">
      <ion-icon name="refresh-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>
