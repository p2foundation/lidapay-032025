<ion-header [translucent]="true" class="ion-no-border">
  <ion-toolbar class="header-toolbar">
    <ion-buttons slot="start">
      <ion-back-button 
        defaultHref="/tabs/home" 
        class="back-button"
        text=""
        icon="arrow-back-outline">
      </ion-back-button>
    </ion-buttons>
    <ion-title class="header-title">
      <div class="title-content">
        <ion-icon name="time-outline" class="title-icon"></ion-icon>
        <span>Pending Transactions</span>
        <ion-badge *ngIf="filteredTransactions.length > 0" color="warning" class="count-badge">
          {{ filteredTransactions.length }}
        </ion-badge>
      </div>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button 
        fill="clear" 
        class="refresh-button"
        (click)="refreshTransactions()" 
        [disabled]="isLoading">
        <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="transactions-content">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <ion-spinner name="crescent" class="loading-spinner"></ion-spinner>
    <p class="loading-text">Loading pending transactions...</p>
  </div>

  <!-- Empty State -->
  <div *ngIf="!isLoading && filteredTransactions.length === 0" class="empty-state">
    <div class="empty-icon">
      <ion-icon name="checkmark-circle-outline" color="success" size="large"></ion-icon>
    </div>
    <h2 class="empty-title">No Pending Transactions</h2>
    <p class="empty-description">All your transactions have been processed successfully!</p>
    <ion-button fill="outline" color="medium" (click)="refreshTransactions()">
      <ion-icon name="refresh-outline" slot="start"></ion-icon>
      Refresh
    </ion-button>
  </div>

  <!-- Content -->
  <div *ngIf="!isLoading && filteredTransactions.length > 0" class="content-wrapper">
    <!-- Search and Filter Section -->
    <ion-card class="filter-card">
      <ion-card-content>
        <ion-grid>
          <ion-row>
            <ion-col size="12" size-md="8">
              <ion-item class="search-item">
                <ion-label position="stacked" class="search-label">
                  <ion-icon name="search-outline"></ion-icon>
                  Search Transactions
                </ion-label>
                <ion-input 
                  [(ngModel)]="searchTerm" 
                  placeholder="Search by phone number, transaction type, or ID"
                  clearInput="true"
                  class="search-input">
                </ion-input>
              </ion-item>
            </ion-col>
            <ion-col size="12" size-md="4">
              <ion-item class="filter-item">
                <ion-label position="stacked" class="filter-label">
                  <ion-icon name="filter-outline"></ion-icon>
                  Status Filter
                </ion-label>
                <ion-select [(ngModel)]="filterStatus" class="status-select">
                  <ion-select-option value="ALL">All Status</ion-select-option>
                  <ion-select-option value="PENDING">Pending</ion-select-option>
                  <ion-select-option value="COMPLETED">Completed</ion-select-option>
                  <ion-select-option value="FAILED">Failed</ion-select-option>
                </ion-select>
              </ion-item>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-card-content>
    </ion-card>

    <!-- Results Summary -->
    <div class="results-summary">
      <ion-chip color="primary" outline>
        <ion-icon name="information-circle-outline"></ion-icon>
        <ion-label>Showing {{ filteredTransactions.length }} of {{ pendingTransactions.length }} pending transactions</ion-label>
      </ion-chip>
    </div>

    <!-- Transactions List -->
    <div class="transactions-list">
      <ion-card *ngFor="let transaction of sortTransactionsByPriority(filteredTransactions)" 
                class="transaction-card"
                [ngClass]="transaction.status && transaction.status.transaction ? transaction.status.transaction : ''">
        <ion-card-content>
          <!-- Transaction Header -->
          <div class="transaction-header">
            <div class="transaction-type">
              <ion-chip [color]="getStatusColor(transaction.status && transaction.status.transaction ? transaction.status.transaction : 'unknown')" 
                       class="type-chip">
                <ion-icon [name]="getTransactionTypeIcon(transaction.transType)"></ion-icon>
                <ion-label>{{ getTransactionTypeLabel(transaction.transType) }}</ion-label>
              </ion-chip>
            </div>
            <div class="transaction-status">
              <ion-badge [color]="getStatusColor(transaction.status && transaction.status.transaction ? transaction.status.transaction : 'unknown')" 
                        class="status-badge">
                <ion-icon [name]="getStatusIcon(transaction.status && transaction.status.transaction ? transaction.status.transaction : 'unknown')"></ion-icon>
                {{ transaction.status && transaction.status.transaction ? transaction.status.transaction.toUpperCase() : 'UNKNOWN' }}
              </ion-badge>
            </div>
          </div>

          <!-- Transaction Details -->
          <div class="transaction-details">
            <div class="detail-row amount-row">
              <span class="label">
                <ion-icon name="cash-outline"></ion-icon>
                Amount:
              </span>
              <span class="value amount">
                {{ transaction.monetary.currency }} {{ formatAmount(transaction.monetary.amount) }}
              </span>
            </div>
            
            <div class="detail-row">
              <span class="label">
                <ion-icon name="phone-portrait-outline"></ion-icon>
                Recipient:
              </span>
              <span class="value phone" 
                    [ngClass]="{'invalid-phone': !getPhoneNumberValidation(transaction.recipientNumber).isValid}">
                {{ formatPhoneNumber(transaction.recipientNumber) }}
                <ion-chip *ngIf="getPhoneNumberValidation(transaction.recipientNumber).isValid" 
                         size="small" 
                         color="success" 
                         class="network-chip">
                  {{ getPhoneNumberValidation(transaction.recipientNumber).network }}
                </ion-chip>
              </span>
            </div>
            
            <div class="detail-row">
              <span class="label">
                <ion-icon name="information-circle-outline"></ion-icon>
                Transaction ID:
              </span>
              <span class="value transaction-id">{{ transaction.transId }}</span>
            </div>
            
            <div class="detail-row">
              <span class="label">
                <ion-icon name="business-outline"></ion-icon>
                Retailer:
              </span>
              <span class="value">{{ transaction.retailer }}</span>
            </div>
            
            <div class="detail-row">
              <span class="label">
                <ion-icon name="person-outline"></ion-icon>
                Customer:
              </span>
              <span class="value">{{ transaction.firstName }} {{ transaction.lastName }}</span>
            </div>
            
            <div class="detail-row">
              <span class="label">
                <ion-icon name="calendar-outline"></ion-icon>
                Created:
              </span>
              <span class="value">{{ formatDate(transaction.createdAt) }}</span>
            </div>
            
            <div class="detail-row">
              <span class="label">
                <ion-icon name="time-outline"></ion-icon>
                Updated:
              </span>
              <span class="value">{{ formatDate(transaction.updatedAt) }}</span>
            </div>
          </div>

          <!-- Status Breakdown Section -->
          <div class="status-breakdown" (click)="toggleStatusBreakdown()">
            <div class="status-breakdown-header">
              <ion-icon name="analytics-outline" class="status-icon"></ion-icon>
              <span class="status-title">Status Breakdown</span>
              <ion-icon 
                [name]="isStatusBreakdownOpen ? 'chevron-up-outline' : 'chevron-down-outline'" 
                class="collapse-icon">
              </ion-icon>
            </div>
            
            <div class="status-breakdown-content" *ngIf="isStatusBreakdownOpen">
              <div class="status-grid">
                <div class="status-item">
                  <ion-icon name="swap-horizontal-outline" class="status-icon"></ion-icon>
                  <span class="status-text">Transaction: {{ transaction.status && transaction.status.transaction ? transaction.status.transaction : 'pending' }}</span>
                </div>
                <div class="status-item">
                  <ion-icon name="construct-outline" class="status-icon"></ion-icon>
                  <span class="status-text">Service: {{ transaction.status && transaction.status.service ? transaction.status.service : 'pending' }}</span>
                </div>
                <div class="status-item">
                  <ion-icon name="card-outline" class="status-icon"></ion-icon>
                  <span class="status-text">Payment: {{ transaction.status && transaction.status.payment ? transaction.status.payment : 'pending' }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="transaction-actions">
            <ion-button 
              expand="block" 
              color="primary" 
              class="check-status-btn"
              (click)="checkTransactionStatus(transaction)"
              [disabled]="isCheckingStatus && checkingTransactionId === transaction._id">
              <ion-icon name="refresh-outline" slot="start" *ngIf="isCheckingStatus && checkingTransactionId === transaction._id"></ion-icon>
              <ion-spinner name="dots" slot="start" *ngIf="isCheckingStatus && checkingTransactionId === transaction._id"></ion-spinner>
              <ion-icon name="time-outline" slot="start" *ngIf="!(isCheckingStatus && checkingTransactionId === transaction._id)"></ion-icon>
              {{ (isCheckingStatus && checkingTransactionId === transaction._id) ? 'Checking...' : 'Check Status' }}
            </ion-button>
            
            <ion-button 
              expand="block" 
              fill="outline" 
              color="secondary" 
              class="view-details-btn"
              (click)="viewTransactionDetails(transaction)"
              [disabled]="isCheckingStatus">
              <ion-icon name="eye-outline" slot="start"></ion-icon>
              View Details
            </ion-button>
          </div>
        </ion-card-content>
      </ion-card>
    </div>

    <!-- Load More Button -->
    <div *ngIf="hasMoreData && !isLoading" class="load-more-container">
      <ion-button 
        expand="block" 
        fill="outline" 
        color="medium"
        class="load-more-btn"
        (click)="loadMoreTransactions()">
        <ion-icon name="arrow-down-outline" slot="start"></ion-icon>
        Load More Transactions
      </ion-button>
    </div>
  </div>

  <!-- Floating Action Button for Refresh -->
  <ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="!isLoading">
    <ion-fab-button (click)="refreshTransactions()" [disabled]="isLoading" class="fab-button">
      <ion-icon name="refresh-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>
</ion-content>
