<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/recharge"></ion-back-button>
    </ion-buttons>
    <ion-title>
      <div class="d-flex">
        <span class="page_title">
          {{'Data Bundle' | translate}}
        </span>
      </div>
    </ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="ion-padding">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="ion-text-center ion-padding">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Loading data bundles...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="!isLoading && dataBundle.length === 0" class="ion-text-center ion-padding">
    <ion-icon name="warning-outline" style="font-size: 48px;"></ion-icon>
    <h3>No Data Bundles Available</h3>
    <p>Unable to load data bundles at this time. Please go back and try again.</p>
    <ion-button routerLink="/tabs/recharge/internet" fill="clear">
      <ion-icon slot="start" name="arrow-back"></ion-icon>
      Go Back
    </ion-button>
  </div>

  <!-- Bundle List -->
  <form [formGroup]="dataBundleForm" (ngSubmit)="onSubmit(dataBundleForm.value)" *ngIf="!isLoading && dataBundle.length > 0" class="ion-padding">
    <!-- Recipient Number Input -->
    <!-- <ion-item class="ion-margin-bottom">
      <ion-label position="floating">Recipient's Phone Number</ion-label>
      <ion-input 
        type="tel" 
        formControlName="recipientNumber" 
        placeholder="Enter phone number"
        inputmode="tel"
        [value]="userProfile?.phoneNumber || ''">
      </ion-input>
      <ion-note slot="helper">Enter recipient's phone number with country code</ion-note>
      <ion-note slot="error" *ngIf="dataBundleForm.get('recipientNumber')?.errors?.['required'] && dataBundleForm.get('recipientNumber')?.touched">
        Phone number is required
      </ion-note>
      <ion-note slot="error" *ngIf="dataBundleForm.get('recipientNumber')?.errors?.['minlength']">
        Phone number is too short
      </ion-note>
    </ion-item> -->

    <ion-text color="dark">
      <h2>Select Data Bundle</h2>
      <p class="ion-text-muted">Choose a bundle that suits your needs</p>
    </ion-text>
    
    <div class="bundle-grid">
      <ion-row>
        <ion-col size="12" size-md="6" size-lg="4" *ngFor="let bundle of dataBundle">
          <ion-card 
            [class.selected]="selectedBundle?.code === bundle.code"
            (click)="selectBundle(bundle)"
            class="bundle-card"
            [class.flexi-bundle]="bundle['flexible_amount']"
          >
            <ion-card-header>
              <ion-card-title class="bundle-name">
                {{bundle['name'] || bundle.volume}}
                <span *ngIf="bundle['flexible_amount']" class="flexi-badge">Flexi</span>
              </ion-card-title>
              <ion-card-subtitle class="bundle-network">
                <ion-icon [name]="getNetworkIcon(getNetworkName(bundle.network))"></ion-icon>
                {{ getNetworkName(bundle.network) }}
                <span *ngIf="bundle['category'] && bundle['category'] !== 'FIBRE' && bundle['category'] !== 'Flexi'" class="bundle-category">
                  â€¢ {{bundle['category'].replace('_', ' ')}}
                </span>
              </ion-card-subtitle>
            </ion-card-header>
            
            <ion-card-content>
              <div class="bundle-content">
                <h2 class="bundle-amount">{{formatAmount(bundle.amount || bundle.price || bundle['bundleAmount'] || 0)}}</h2>
                <p class="bundle-validity" *ngIf="bundle.validity !== 'N/A'">
                  {{bundle.validity || bundle.bundleValidity || '30 days'}}
                </p>
                <p class="bundle-volume" *ngIf="bundle.volume && bundle.volume !== 'Flexi'">
                  {{bundle.volume || bundle.bundleVolume}}
                </p>
                
                <ion-button 
                  expand="block" 
                  fill="outline"
                  size="small"
                  type="button"
                  (click)="selectBundle(bundle); $event.stopPropagation()"
                  class="select-button"
                  [disabled]="bundle['flexible_amount']"
                >
                  {{ selectedBundle?.code === bundle.code ? 'Selected' : 'Select' }}
                  <ion-icon *ngIf="selectedBundle?.code === bundle.code" name="checkmark-circle" slot="end"></ion-icon>
                </ion-button>
                <ion-note *ngIf="bundle['flexible_amount']" class="flexi-note">
                  Custom amount available
                </ion-note>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </div>
    
    <div class="ion-padding-horizontal ion-margin-top">
      <ion-button 
        expand="block" 
        size="large" 
        type="submit"
        [disabled]="!dataBundleForm.valid || !selectedBundle"
        class="purchase-button"
        shape="round"
      >
        <ion-icon slot="start" name="card"></ion-icon>
        {{ selectedBundle ? 'Buy ' + (selectedBundle.volume || selectedBundle.bundleVolume) + ' for ' + formatAmount(selectedBundle.amount || selectedBundle.price || selectedBundle['bundleAmount'] || 0) : 'Please select a bundle' }}
      </ion-button>
    </div>
  </form>
</ion-content>
