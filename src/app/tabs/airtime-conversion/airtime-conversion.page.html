<ion-header [translucent]="true">
  <ion-toolbar class="header-toolbar">
    <ion-buttons slot="start">
      <ion-back-button 
        defaultHref="/tabs/home" 
        (click)="goBack()"
        icon="arrow-back-outline">
      </ion-back-button>
    </ion-buttons>
    <ion-title class="header-title">
      <div class="title-content">
        <ion-icon name="repeat-outline" class="title-icon"></ion-icon>
        <span>Airtime Conversion</span>
      </div>
    </ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="showInfo()">
        <ion-icon name="information-circle-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="airtime-conversion-content">
  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Loading conversion options...</p>
  </div>

  <!-- Main Content -->
  <div class="content-wrapper" [class.animate-in]="!isLoading">
    <!-- Hero Section -->
    <div class="hero-section">
      <div class="hero-content">
        <div class="hero-icon">
          <ion-icon name="repeat-outline"></ion-icon>
        </div>
        <h1 class="hero-title">Convert Airtime to Cash</h1>
        <p class="hero-subtitle">Transform your airtime into cash, wallet credit, or other services instantly</p>
      </div>
    </div>

    <!-- Accordion-Style Wizard Steps -->
    <div class="wizard-accordion">
      <div class="accordion-container">
        <!-- Step 1: Network Provider -->
        <div id="step-0" class="step-card" [class.completed]="isStepCompleted(0)" [class.active]="activeStep === 0" [class.disabled]="!isStepCompleted(0) && activeStep > 0">
          <div class="step-header" (click)="toggleStep(0)">
            <div class="step-number">1</div>
            <div class="step-info">
              <h3>Network Provider</h3>
              <p>Choose your network</p>
            </div>
            <div class="step-status" *ngIf="isStepCompleted(0)">
              <ion-icon name="checkmark-circle" color="success"></ion-icon>
            </div>
            <ion-icon class="expand-icon" [name]="activeStep === 0 ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
          </div>
          
          <div class="step-content" [class.expanded]="activeStep === 0">
            <div class="network-providers-grid">
              <div 
                *ngFor="let provider of networkProviders; trackBy: trackByProvider" 
                class="provider-card"
                [class.selected]="selectedProvider === provider.id"
                [class.disabled]="!provider.isActive"
                (click)="selectProvider(provider.id)">
                <div class="provider-logo">
                  <div class="logo-circle" [style.background]="getProviderColor(provider.id)">
                    <span class="logo-text">{{ getProviderInitials(provider.name) }}</span>
                  </div>
                </div>
                <div class="provider-info">
                  <h4 class="provider-name">{{ provider.name }}</h4>
                  <p class="provider-status" *ngIf="provider.isActive">Available</p>
                  <p class="provider-status disabled" *ngIf="!provider.isActive">Coming Soon</p>
                </div>
                <div class="provider-checkmark" *ngIf="selectedProvider === provider.id">
                  <ion-icon name="checkmark-circle"></ion-icon>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2: Airtime Details -->
        <div class="step-card" [class.completed]="isStepCompleted(1)" [class.active]="activeStep === 1" [class.disabled]="!isStepCompleted(0)">
          <div class="step-header" (click)="toggleStep(1)">
            <div class="step-number">2</div>
            <div class="step-info">
              <h3>Airtime Details</h3>
              <p>Enter phone number and amount</p>
            </div>
            <div class="step-status" *ngIf="isStepCompleted(1)">
              <ion-icon name="checkmark-circle" color="success"></ion-icon>
            </div>
            <ion-icon class="expand-icon" [name]="activeStep === 1 ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
          </div>
          
          <div class="step-content" [class.expanded]="activeStep === 1">
            <div class="form-section">
              <div class="form-group">
                <ion-label>Phone Number</ion-label>
                <ion-input 
                  [(ngModel)]="phoneNumber"
                  [formControl]="phoneNumberControl"
                  type="tel"
                  inputmode="tel"
                  placeholder="Enter phone number (e.g., 0241234567)"
                  (ionInput)="validateStep(1)"
                  [class.ion-invalid]="phoneNumberControl.invalid && phoneNumberControl.touched"
                  class="form-input">
                </ion-input>
                <div *ngIf="phoneNumberControl.touched && phoneNumberControl.errors?.['required']" class="error-message">
                  Phone number is required
                </div>
                <div *ngIf="phoneNumberControl.touched && phoneNumberControl.errors?.['pattern']" class="error-message">
                  Please enter a valid Ghanaian phone number
                </div>
              </div>
              
              <div class="form-group">
                <ion-label>Airtime Amount (‚Çµ)</ion-label>
                <ion-input 
                  [(ngModel)]="airtimeAmount"
                  [formControl]="amountControl"
                  type="number"
                  inputmode="decimal"
                  min="1"
                  placeholder="Enter amount (e.g., 100)"
                  (ionInput)="onAmountChange(); validateStep(1)"
                  [class.ion-invalid]="amountControl.invalid && amountControl.touched"
                  class="form-input">
                </ion-input>
                <div *ngIf="amountControl.touched && amountControl.errors?.['required']" class="error-message">
                  Amount is required
                </div>
                <div *ngIf="amountControl.touched && amountControl.errors?.['min']" class="error-message">
                  Amount must be greater than 0
                </div>
              </div>
              
              <div class="quick-actions">
                <ion-button 
                  fill="outline" 
                  size="small"
                  (click)="fillSampleData()"
                  class="quick-btn"
                  [disabled]="isLoading">
                  <ion-icon name="flash-outline" slot="start"></ion-icon>
                  {{ isLoading ? 'Loading...' : 'Use Sample Data' }}
                  <ion-spinner *ngIf="isLoading" name="crescent" slot="end"></ion-spinner>
                </ion-button>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: Conversion Method -->
        <div class="step-card" [class.completed]="isStepCompleted(2)" [class.active]="activeStep === 2" [class.disabled]="!isStepCompleted(1)">
          <div class="step-header" (click)="toggleStep(2)">
            <div class="step-number">3</div>
            <div class="step-info">
              <h3>Conversion Method</h3>
              <p>Choose how to receive funds</p>
            </div>
            <div class="step-status" *ngIf="isStepCompleted(2)">
              <ion-icon name="checkmark-circle" color="success"></ion-icon>
            </div>
            <ion-icon class="expand-icon" [name]="activeStep === 2 ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
          </div>
          
          <div class="step-content" [class.expanded]="activeStep === 2">
            <div class="conversion-options-grid">
              <div 
                *ngFor="let option of conversionOptions" 
                class="conversion-option-card"
                [class.selected]="selectedConversionOption === option.id"
                [class.popular]="option.isPopular"
                [class.recommended]="option.isRecommended"
                (click)="selectConversionOption(option.id)">
                
                <div class="option-badges" *ngIf="option.isPopular || option.isRecommended">
                  <ion-badge *ngIf="option.isRecommended" color="primary">‚≠ê Recommended</ion-badge>
                  <ion-badge *ngIf="option.isPopular" color="success">üî• Popular</ion-badge>
                </div>
                
                <div class="option-header">
                  <div class="option-icon">
                    <ion-icon [name]="option.icon"></ion-icon>
                  </div>
                  <div class="option-details">
                    <h4 class="option-title">{{ option.name }}</h4>
                    <p class="option-description">{{ option.description }}</p>
                  </div>
                  <div class="option-rate">
                    <span class="rate-value">{{ getRatePercentage(option.rate) }}</span>
                    <span class="rate-label">Rate</span>
                  </div>
                </div>
                
                <div class="option-features">
                  <div class="feature">
                    <ion-icon name="time-outline"></ion-icon>
                    <span>{{ option.processingTime }}</span>
                  </div>
                  <div class="feature">
                    <ion-icon name="cash-outline"></ion-icon>
                    <span>‚Çµ{{ option.minAmount }}-‚Çµ{{ option.maxAmount }}</span>
                  </div>
                  <div class="feature">
                    <ion-icon name="card-outline"></ion-icon>
                    <span *ngIf="option.fees > 0">Fee: ‚Çµ{{ option.fees }}</span>
                    <span *ngIf="option.fees === 0" class="free">Free</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 4: Review & Confirm -->
        <div class="step-card" [class.completed]="isStepCompleted(3)" [class.active]="activeStep === 3" [class.disabled]="!isStepCompleted(2)">
          <div class="step-header" (click)="toggleStep(3)">
            <div class="step-number">4</div>
            <div class="step-info">
              <h3>Review & Confirm</h3>
              <p>Verify your details</p>
            </div>
            <div class="step-status" *ngIf="isStepCompleted(3)">
              <ion-icon name="checkmark-circle" color="success"></ion-icon>
            </div>
            <ion-icon class="expand-icon" [name]="activeStep === 3 ? 'chevron-up-outline' : 'chevron-down-outline'"></ion-icon>
          </div>
          
          <div class="step-content" [class.expanded]="activeStep === 3">
            <div class="review-section">
              <div class="review-item">
                <span class="review-label">Network Provider:</span>
                <span class="review-value">{{ getProviderName() }}</span>
              </div>
              <div class="review-item">
                <span class="review-label">Phone Number:</span>
                <span class="review-value">{{ phoneNumber || 'Not entered' }}</span>
              </div>
              <div class="review-item">
                <span class="review-label">Airtime Amount:</span>
                <span class="review-value">‚Çµ{{ airtimeAmount || 0 }}</span>
              </div>
              <div class="review-item">
                <span class="review-label">Conversion Method:</span>
                <span class="review-value">{{ getSelectedOptionName() }}</span>
              </div>
            </div>

            <div class="summary-section" *ngIf="airtimeAmount > 0">
              <h4>Conversion Summary</h4>
              <div class="summary-grid">
                <div class="summary-item">
                  <span class="summary-label">Original Amount:</span>
                  <span class="summary-value">‚Çµ{{ airtimeAmount.toLocaleString() }}</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Conversion Rate:</span>
                  <span class="summary-value">{{ getRatePercentage(getSelectedOption()?.rate || 0) }}</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Processing Fee:</span>
                  <span class="summary-value fee">‚Çµ{{ processingFee.toLocaleString() }}</span>
                </div>
                <div class="summary-item total">
                  <span class="summary-label">You'll Receive:</span>
                  <span class="summary-value total-amount">‚Çµ{{ totalAmount.toLocaleString() }}</span>
                </div>
              </div>
            </div>

            <div class="action-buttons">
              <ion-button 
                expand="block"
                class="confirm-btn"
                [disabled]="!canConfirmConversion() || isProcessing"
                (click)="processConversion()"
                [color]="canConfirmConversion() && !isProcessing ? 'primary' : 'medium'">
                <ion-icon name="repeat-outline" slot="start"></ion-icon>
                <span *ngIf="!isProcessing">
                  {{ canConfirmConversion() ? 'Confirm Conversion' : 'Complete all steps' }}
                </span>
                <span *ngIf="isProcessing">Processing...</span>
                <ion-spinner *ngIf="isProcessing" name="crescent" slot="end"></ion-spinner>
              </ion-button>
              
              <div *ngIf="errorMessage" class="error-message ion-margin-top">
                <ion-icon name="warning-outline"></ion-icon>
                {{ errorMessage }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Features Section -->
    <div class="features-section">
      <h3 class="features-title">Why Choose Our Airtime Conversion?</h3>
      <div class="features-grid">
        <div class="feature-item">
          <div class="feature-icon">
            <ion-icon name="shield-checkmark-outline"></ion-icon>
          </div>
          <h4>Secure & Safe</h4>
          <p>Bank-grade security for all transactions</p>
        </div>
        <div class="feature-item">
          <div class="feature-icon">
            <ion-icon name="time-outline"></ion-icon>
          </div>
          <h4>Fast Processing</h4>
          <p>Most conversions completed within minutes</p>
        </div>
        <div class="feature-item">
          <div class="feature-icon">
            <ion-icon name="trending-up-outline"></ion-icon>
          </div>
          <h4>Best Rates</h4>
          <p>Competitive conversion rates across all networks</p>
        </div>
        <div class="feature-item">
          <div class="feature-icon">
            <ion-icon name="help-circle-outline"></ion-icon>
          </div>
          <h4>24/7 Support</h4>
          <p>Round-the-clock customer support</p>
        </div>
      </div>
    </div>
  </div>
</ion-content>

<!-- Alerts -->
<ion-alert
  [isOpen]="showInfoAlert"
  header="Airtime Conversion Info"
  message="Convert your airtime to cash, wallet credit, or other services. Rates vary by network and conversion type. Processing times range from instant to a few hours depending on the option chosen."
  [buttons]="['Got it!']"
  (didDismiss)="showInfoAlert = false">
</ion-alert> 