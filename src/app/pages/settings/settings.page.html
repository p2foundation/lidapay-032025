<ion-header class="header_bg" [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <div class="header-content">
      <span class="page_title animate__animated animate__fadeIn">
        {{ 'Settings' | translate }}
      </span>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content class="bg_color" [fullscreen]="true">
  <!-- Profile Preview -->
  <div class="profile-preview animate__animated animate__fadeIn" *ngIf="profile">
    <div class="profile-image" [ngStyle]="{'background-image': 'url(' + (profile.gravatar || 'assets/imgs/avatar-placeholder.png') + ')'}">
      <div class="edit-overlay" (click)="goToUpdateProfile()">
        <ion-icon name="camera"></ion-icon>
      </div>
    </div>
    <h2>{{ profile.firstName }} {{ profile.lastName }}</h2>
    <p>{{ profile.email }}</p>
  </div>

  <div class="settings-sections">
    <!-- Account Section -->
    <div class="section-title">{{ 'Account' | translate }}</div>
    <ion-list lines="none">
      <ion-item class="setting-item animate__animated animate__fadeInUp" (click)="gotoUserProfile()">
        <div class="icon_box" slot="start">
          <ion-icon name="person-outline"></ion-icon>
        </div>
        <ion-label>
          <h2>{{ 'Profile' | translate }}</h2>
          <p>{{ 'View and edit your profile details' | translate }}</p>
        </ion-label>
        <ion-icon name="chevron-forward" slot="end"></ion-icon>
      </ion-item>

      <ion-item class="setting-item animate__animated animate__fadeInUp" (click)="gotoVerification()">
        <div class="icon_box verification" slot="start">
          <ion-icon name="shield-checkmark-outline"></ion-icon>
        </div>
        <ion-label>
          <h2>{{ 'Verification' | translate }}</h2>
          <p>{{ 'Verify your account for full access' | translate }}</p>
        </ion-label>
        <ion-badge slot="end" [color]="profile.emailVerified ? 'success' : 'warning'">
          {{ profile.emailVerified ? ('Verified' | translate) : ('Pending' | translate) }}
        </ion-badge>
      </ion-item>

      <!-- Rewards Section -->
      <ion-item class="setting-item animate__animated animate__fadeInUp" (click)="showQRCodeOptions()">
        <div class="icon_box rewards" slot="start">
          <ion-icon name="qr-code-outline"></ion-icon>
        </div>
        <ion-label>
          <h2>{{ 'My QR Code' | translate }}</h2>
          <p>{{ 'Share your code to earn rewards' | translate }}</p>
        </ion-label>
        <ion-icon name="share-social-outline" slot="end"></ion-icon>
      </ion-item>
    </ion-list>

    <!-- Security Section -->
    <div class="section-title">{{ 'Security' | translate }}</div>
    <ion-list lines="none">
      <ion-item class="setting-item animate__animated animate__fadeInUp" (click)="gotoSecurity()">
        <div class="icon_box security" slot="start">
          <ion-icon name="lock-closed-outline"></ion-icon>
        </div>
        <ion-label>
          <h2>{{ 'Security Settings' | translate }}</h2>
          <p>{{ 'Manage your security preferences' | translate }}</p>
        </ion-label>
        <ion-icon name="chevron-forward" slot="end"></ion-icon>
      </ion-item>

      <ion-item class="setting-item animate__animated animate__fadeInUp" (click)="changePassword()">
        <div class="icon_box password" slot="start">
          <ion-icon name="key-outline"></ion-icon>
        </div>
        <ion-label>
          <h2>{{ 'Change Password' | translate }}</h2>
          <p>{{ 'Update your password' | translate }}</p>
        </ion-label>
        <ion-icon name="chevron-forward" slot="end"></ion-icon>
      </ion-item>
    </ion-list>

    <!-- Preferences Section -->
    <div class="section-title">{{ 'Preferences' | translate }}</div>
    <ion-list lines="none">
      <ion-item class="setting-item animate__animated animate__fadeInUp" (click)="change_language()">
        <div class="icon_box language" slot="start">
          <ion-icon name="language-outline"></ion-icon>
        </div>
        <ion-label>
          <h2>{{ 'Language' | translate }}</h2>
          <p>{{ currentLanguage | uppercase }}</p>
        </ion-label>
        <ion-icon name="chevron-forward" slot="end"></ion-icon>
      </ion-item>

      <ion-item class="setting-item animate__animated animate__fadeInUp">
        <div class="icon_box theme" slot="start">
          <ion-icon name="moon-outline"></ion-icon>
        </div>
        <ion-label>
          <h2>{{ 'Dark Mode' | translate }}</h2>
          <p>{{ 'Toggle dark theme' | translate }}</p>
        </ion-label>
        <ion-toggle [(ngModel)]="isDarkMode" (ionChange)="toggleDarkMode($event)"></ion-toggle>
      </ion-item>
    </ion-list>
  </div>
</ion-content>

<!-- QR Code Modal -->
<ion-modal [isOpen]="isQRModalOpen" [breakpoints]="[0, 0.5, 0.8]" [initialBreakpoint]="0.5" class="qr-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ 'Your QR Code' | translate }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeQRModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="qr-modal-content">
      <div class="qr-container">
        <div class="qr-wrapper" #qrWrapper>
          <!-- Add loading spinner -->
          <ion-spinner *ngIf="!qrCodeDataUrl"></ion-spinner>
          <!-- Show QR code when available -->
          <img [src]="qrCodeDataUrl" 
               alt="QR Code" 
               *ngIf="qrCodeDataUrl"
               class="qr-code-image"/>
          <div class="profile-info" *ngIf="profile && qrCodeDataUrl">
            <img [src]="profile.gravatar || 'assets/imgs/avatar-placeholder.png'" 
                 alt="profile.firstName + '\'s profile picture'" 
                 class="profile-avatar"/>
            <h3>{{ profile.firstName }} {{ profile.lastName }}</h3>
            <p>{{ 'Scan to connect' | translate }}</p>
          </div>
        </div>
        <!-- Only show actions if QR code is available -->
        <div class="qr-actions" *ngIf="qrCodeDataUrl">
          <ion-button expand="block" (click)="shareQRCode()">
            <ion-icon name="share-social-outline" slot="start"></ion-icon>
            {{ 'Share QR Code' | translate }}
          </ion-button>
          <ion-button expand="block" color="secondary" (click)="downloadQRCode()">
            <ion-icon name="download-outline" slot="start"></ion-icon>
            {{ 'Download' | translate }}
          </ion-button>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
