<ion-header class="header_bg" [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <div class="header-content">
      <span class="page_title animate__animated animate__fadeIn">
        {{ 'settings_page.settings' | translate }}
      </span>
    </div>
  </ion-toolbar>
</ion-header>

<ion-content class="bg_color" [fullscreen]="true">
  <!-- Profile Preview -->
  <div class="profile-preview animate__animated animate__fadeIn" *ngIf="profile">
    <div class="profile-image" [ngStyle]="{'background-image': 'url(' + (profile.gravatar || 'assets/imgs/avatar-placeholder.png') + ')'}">
      <div class="edit-overlay" (click)="goToUpdateProfile()">
        <ion-icon name="camera"></ion-icon>
      </div>
    </div>
    <h2>{{ profile.firstName }} {{ profile.lastName }}</h2>
    <p>{{ profile.email }}</p>
  </div>

  <div class="settings-sections">
    <!-- Account Section -->
    <div class="section-title">{{ 'settings_page.account' | translate }}</div>
    <ion-list lines="none">
      <ion-item class="setting-item animate__animated animate__fadeInUp" (click)="gotoUserProfile()">
        <div class="icon_box" slot="start">
          <ion-icon name="person-outline"></ion-icon>
        </div>
        <ion-label>
          <h2>{{ 'settings_page.profile' | translate }}</h2>
          <p>{{ 'settings_page.profile_description' | translate }}</p>
        </ion-label>
        <ion-icon name="chevron-forward" slot="end"></ion-icon>
      </ion-item>

      <ion-item class="setting-item animate__animated animate__fadeInUp" (click)="gotoVerification()">
        <div class="icon_box verification" slot="start">
          <ion-icon name="shield-checkmark-outline"></ion-icon>
        </div>
        <ion-label>
          <h2>{{ 'settings_page.verification' | translate }}</h2>
          <p>{{ 'settings_page.verification_description' | translate }}</p>
        </ion-label>
        <ion-badge slot="end" [color]="profile.emailVerified ? 'success' : 'warning'">
          {{ profile.emailVerified ? ('settings_page.verified' | translate) : ('settings_page.pending' | translate) }}
        </ion-badge>
      </ion-item>

      <!-- Rewards Section -->
      <ion-item class="setting-item animate__animated animate__fadeInUp" (click)="showQRCodeOptions()">
        <div class="icon_box rewards" slot="start">
          <ion-icon name="qr-code-outline"></ion-icon>
        </div>
        <ion-label>
          <h2>{{ 'settings_page.my_qr_code' | translate }}</h2>
          <p>{{ 'settings_page.qr_code_description' | translate }}</p>
        </ion-label>
        <ion-icon name="share-social-outline" slot="end"></ion-icon>
      </ion-item>
    </ion-list>

    <!-- Security Section -->
    <div class="section-title">{{ 'settings_page.security' | translate }}</div>
    <ion-list lines="none">
      <ion-item class="setting-item animate__animated animate__fadeInUp" (click)="gotoSecurity()">
        <div class="icon_box security" slot="start">
          <ion-icon name="lock-closed-outline"></ion-icon>
        </div>
        <ion-label>
          <h2>{{ 'settings_page.security_settings' | translate }}</h2>
          <p>{{ 'settings_page.security_description' | translate }}</p>
        </ion-label>
        <ion-icon name="chevron-forward" slot="end"></ion-icon>
      </ion-item>

      <ion-item class="setting-item animate__animated animate__fadeInUp" (click)="changePassword()">
        <div class="icon_box password" slot="start">
          <ion-icon name="key-outline"></ion-icon>
        </div>
        <ion-label>
          <h2>{{ 'settings_page.change_password' | translate }}</h2>
          <p>{{ 'settings_page.password_description' | translate }}</p>
        </ion-label>
        <ion-icon name="chevron-forward" slot="end"></ion-icon>
      </ion-item>
    </ion-list>

    <!-- Preferences Section -->
    <div class="section-title">{{ 'settings_page.preferences' | translate }}</div>
    <ion-list lines="none">
      <ion-item class="setting-item animate__animated animate__fadeInUp" (click)="change_language()">
        <div class="icon_box language" slot="start">
          <ion-icon name="language-outline"></ion-icon>
        </div>
        <ion-label>
          <h2>{{ 'settings_page.language' | translate }}</h2>
          <p>{{ currentLanguage | uppercase }}</p>
        </ion-label>
        <ion-icon name="chevron-forward" slot="end"></ion-icon>
      </ion-item>

      <ion-item class="setting-item animate__animated animate__fadeInUp" button detail="true" (click)="openThemeSelector()">
        <div class="icon_box theme" slot="start">
          <ion-icon [name]="getThemeModeIcon()"></ion-icon>
        </div>
        <ion-label>
          <h2>{{ 'settings_page.theme' | translate }}</h2>
          <p>{{ getThemeModeDescription() | translate }}</p>
        </ion-label>
        <ion-note slot="end">{{ getThemeModeLabel() | translate }}</ion-note>
        <ion-icon name="chevron-forward" slot="end"></ion-icon>
      </ion-item>
    </ion-list>
  </div>
</ion-content>

<!-- QR Code Modal -->
<ion-modal [isOpen]="isQRModalOpen" [breakpoints]="[0, 0.5, 0.8]" [initialBreakpoint]="0.5" class="qr-modal">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ 'settings_page.your_qr_code' | translate }}</ion-title>
        <ion-buttons slot="end">
          <ion-button (click)="closeQRModal()">
            <ion-icon name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="qr-modal-content">
      <div class="qr-container">
        <div class="qr-wrapper" #qrWrapper>
          <!-- Add loading spinner -->
          <ion-spinner *ngIf="!qrCodeDataUrl"></ion-spinner>
          <!-- Show QR code when available -->
          <img [src]="qrCodeDataUrl" 
               alt="QR Code" 
               *ngIf="qrCodeDataUrl"
               class="qr-code-image"/>
          <div class="profile-info" *ngIf="profile && qrCodeDataUrl">
            <img [src]="profile.gravatar || 'assets/imgs/avatar-placeholder.png'" 
                 alt="profile.firstName + '\'s profile picture'" 
                 class="profile-avatar"/>
            <h3>{{ profile.firstName }} {{ profile.lastName }}</h3>
            <p>{{ 'settings_page.scan_to_connect' | translate }}</p>
          </div>
        </div>
        <!-- Only show actions if QR code is available -->
        <div class="qr-actions" *ngIf="qrCodeDataUrl">
          <ion-button expand="block" (click)="shareQRCode()">
            <ion-icon name="share-social-outline" slot="start"></ion-icon>
            {{ 'settings_page.share_qr_code' | translate }}
          </ion-button>
          <ion-button expand="block" color="secondary" (click)="downloadQRCode()">
            <ion-icon name="download-outline" slot="start"></ion-icon>
            {{ 'settings_page.download' | translate }}
          </ion-button>
        </div>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>
